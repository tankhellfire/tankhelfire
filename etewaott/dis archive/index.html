<!DOCTYPE html>
<html lang="en" oncontextmenu="//return false;">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="color-scheme" content="light dark">
  <title>name</title>
  <script src="/new.js"></script>
  <script src="../../lib/lib.js"></script>
  <script src="../../lib/fs.js"></script>
  <style>
    *{margin:0;font-family:Consolas,monospace}
  </style>
</head>
<body>
  <button id=button>folder</button>
<script>
  async function getGuildsFull(){
    return Object.fromEntries((await Promise.all((await getUsrGuilds()).map(e=>getGuild(e.id)))).map(e=>[e.id,e]))
  }
  function getUsrGuilds(){
    return fetchWAbort(`${apiURL}/users/@me/guilds`,{headers:{authorization}}).then(e=>e.json())
  }
  
  function getGuild(guild){
    return fetchWAbort(`${apiURL}/guilds/${guild}`,{headers:{authorization}}).then(e=>e.json())
  }
  function getGuildChannels(guild){
    return fetchWAbort(`${apiURL}/guilds/${guild}/channels`,{headers:{authorization}}).then(e=>e.json())
  }
  
  async function getAllChannelMsgs(channel){
    let out=[]
    let after=0
    let i=0
    while(1){
      let a=await getChannelMsgs(channel,{limit:100,after})
  
      if(a.length==0)break
      for(let i=a.length-1;0<=i;i--) {
        out.push(a[i])
      }
      
      console.log(i++,(Date.now()-Number(new Date(Number((BigInt(out[out.length-1].id)>>22n)+1420070400000n))))/1000/60/60/24)
      after=a[0].id
    }
    return out
  }
  function getChannelMsgs(channel,{limit=50,after,before}={}){
    let q=[]
    if(limit!=undefined)q.push('limit='+Math.min(Math.max(limit,1),100))
    if(after!=undefined)q.push('after='+after)
    if(before!=undefined)q.push('before='+before)
    return fetchWAbort(`${apiURL}/channels/${channel}/messages?${q.join('&')}`,{headers:{authorization}}).then(e=>e.json())
  }
  
  function downloadStr(content, filename) {
    let link=document.createElement("a")
    link.download=filename
    let url=link.href=URL.createObjectURL(new Blob([content],{type:"text/plain"}))
    document.body.appendChild(link)
    link.click()
    document.body.removeChild(link)
    URL.revokeObjectURL(url)
  }
  async function fetchWAbort(url,options={},timeout=rate,maxRetries=5){
    for(let attempt=1;attempt<=maxRetries;attempt++){
      let controller=new AbortController()
      let id=setTimeout(e=>controller.abort(),timeout)
  
      try{
        let response=await fetch(url,{
          ...options,
          signal:controller.signal
        })
        clearTimeout(id)
  
        return response
      }catch(err){
        clearTimeout(id)
  
        // Only retry if it was aborted (timeout)
        if(err.name==='AbortError'){
          console.warn(`Attempt ${attempt}: Request timed out`)
          if(attempt==maxRetries)throw new Error(`Fetch aborted after ${maxRetries} retries`)
        }else{return err}
      }
    }
  }
  apiURL="https://discord.com/api/v9"
  rate=5000
  button.onclick=_=>showDirectoryPicker().then(h=>(f=new Fs.Folder(h)).requestPermission()+(button.innerHTML=h.name))
  /*
  root
    servers.json
    folder id
      channels.json
      channel id
        msgs.json
        media
          media.json
          media  name
  */
  /*
  [
  {id:data},
  <delta content>
  ]
  */
  
  function isob(obj){return typeof obj==='object'&&obj!==null}

  function findObjectDiff(a,b,maxDepth=100){
    if(maxDepth<0)return null
    let diff=Array.isArray(b)?[]:{}
    for(let key of new Set([...Object.keys(a),...Object.keys(b)])){
      let [ka,kb]=[a[key],b[key]]
      if(ka===kb)continue
      
      if(isob(kb)){
        if(!isob(ka)){
          ka=Array.isArray(kb)?[]:{}
          diff[key]=ka
        }
        let subDiff=findObjectDiff(ka,kb,maxDepth-1)
        if(Object.keys(subDiff).length)diff[key]=subDiff
      continue}
      
      diff[key]=kb
    }
    return diff
  }

  function deepAssign(target,source,destructive=false,maxDepth=100){
    for(let key in source){
      if(source[key]===null){
        target[key]=source[key]
      continue}
      if(destructive&&source[key]===undefined)continue

      if(typeof source[key]==='object'){
        if(target[key]===null||typeof target[key]!=='object')target[key]=Array.isArray(source[key])?[]:{}
        deepAssign(target[key],source[key])
      continue}
      
      target[key]=source[key]
    }
    return target
  }

  async function run(usrId=usr){
    if(typeof guilds==='undefined')guilds={}

    localGuilds=f.get(['guilds.json']).read().then(e=>e.text()).then(e=>JSON.parse(e)).catch(_=>([]))
    guilds[usrId]=await getGuildsFull()
    localGuilds=await localGuilds


    // cannonGuilds={}
  // for(let capture of localGuilds){
  //   for(let captureUser in capture){
  //     deepAssign(cannonGuilds,capture[captureUser],false)
  //   }
  // }
  // cannonGuilds
  // let relativeGuilds={}
  // for(let guildUser in guilds){
  //   relativeGuilds[guildUser]=findObjectDiff(cannonGuilds,guilds[guildUser])
  // }
  // relativeGuilds
    
    
    //await f.get(['guilds.json']).write(JSON.stringify(localGuilds))
  }

  //Object.fromEntries(arr.map(e=>[e.id,e]))
</script>
</body>
</html>