<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Local Chatbot</title>
    <style>
      body {
        font-family: Arial, sans-serif;
      }

      #chatbox {
        width: 100%;
        height: 300px;
        border: 1px solid #ccc;
        padding: 10px;
        overflow-y: scroll;
      }

      #userInput {
        width: 80%;
        padding: 10px;
      }

      #sendButton {
        padding: 10px;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
  </head>
  <body>
    <h1>Local Chatbot</h1>
    <div id="chatbox"></div>
    <input type="text" id="userInput" placeholder="Type your message here..." />
    <button id="sendButton">Send</button>
    <script>
      let session;
      let tokenizer;
      let out;
      let max
      let maxdex
      async function setupChatbot() {
        // if ("serviceWorker"in navigator) {
        //   // navigator.serviceWorker.getRegistrations().then( (a) => {
        //   //   for (var i of a) {
        //   //     console.log("unregistering", i);
        //   //     i.unregister();
        //   //   }
        //   // }
        //   // ).then( () => {
        //     await navigator.serviceWorker.register("https://tankhellfire.glitch.me/chat/sw.js").then( () => {
        //       console.log("Service Worker Registered");
        //     }
        //     )
        //   // }
        //   // )
        // }

        session = await ort.InferenceSession.create(
          "https://huggingface.co/sentence-transformers/all-MiniLM-L6-v2/resolve/main/onnx/model.onnx?download=true",
          {
            executionProviders: ["wasm"],
            graphOptimizationLevel: "all",
          }
        );
        // Update the path to your local ONNX model

        tokenizer = await fetch(
          "https://huggingface.co/sentence-transformers/all-MiniLM-L6-v2/resolve/main/tokenizer.json"
        ).then((res) => res.json());
        tokenizer = tokenizer.model;
        document
          .getElementById("sendButton")
          .addEventListener("click", async () => {
            const userInput = document.getElementById("userInput").value;
            if (userInput.trim() === "") return;

            const chatbox = document.getElementById("chatbox");
            chatbox.innerHTML += `<p><strong>You:</strong> ${userInput}</p>`;
            document.getElementById("userInput").value = "";

            // Tokenize the input
            let inputIds = []
            for(var a in userInput){
              inputIds.push(userInput[a])
              
            }
            tokenizer.vocab[tokenizer.unk_token]
            const attentionMask = new Array(inputIds.length).fill(1);
            const inputTensor = new ort.Tensor(
              "int64",
              new BigInt64Array(inputIds),
              [1, inputIds.length]
            );
            const attentionMaskTensor = new ort.Tensor(
              "int64",
              new BigInt64Array(attentionMask),
              [1, attentionMask.length]
            );

            // Run the model
            const feeds = {
              input_ids: inputTensor,
              attention_mask: attentionMaskTensor,
            };
            const results = await session.run(feeds);
            out = results;
          
            let output=results[Object.keys(results)[0]].data
            max=-Infinity
            maxdex=-1
            for (let i = 0; i < output.length; i++) {
              if(max<output[i]){
                max=output[i]
                maxdex=i
              }
            }
            let a
            for(a in tokenizer.vocab){
              if(tokenizer.vocab[a]==maxdex){
                break
              }
            }
            output=a

            // Decode the output
            const botResponse = a

            chatbox.innerHTML += `<p><strong>Bot:</strong> ${botResponse}</p>`;
            chatbox.scrollTop = chatbox.scrollHeight;
          });
      }

      setupChatbot();
    </script>
  </body>
</html>
