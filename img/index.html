<!DOCTYPE html>
<html lang="en" oncontextmenu="//return false;">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="color-scheme" content="light dark">
  <title>name</title>
  <script src="../new.js"></script>
  <script src="../lib/lib.js"></script>
  <script src="../lib/img/bti.js"></script>
  <style>
    *{margin:0;font-family:Consolas,monospace}
  </style>
</head>
<body>
  <h1 id="statusCard">awaiting js</h1>
<textarea id='textarea' title="quotes">
Hi!
hello.
how are you?</textarea>
  <br>
  <input type="number" id="blocksize" placeholder="block size" value="20" title="block size">
  <input type="text" id="font" placeholder="font" value="13px Consolas" title="font">
  <br>
  <input type="number" id="dpi" placeholder="dpi" value="100" title="dpi">
  <span id="buildinfo"></span>
  <br>
  <canvas id="can" style="image-rendering:pixelated"></canvas>
  <script>

;(async()=>{

loading=async(t)=>console.log(statusCard.textContent=`${t} ${performance.now()/1000}`)
await loading('importing')

if(typeof bti=='undefined'){
  if(typeof lib=='undefined'){
    await loading('importing/lib')
    lib=eval(await(await fetch(__dirname+'lib/lib.js')).text())
  }
  await loading('importing/img/bti')
  bti=await lib('img/bti.js')
}

KnuthShuffle=arr=>{
  for(let i=arr.length-1;0<i;i--){
    let j=Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]]
  }
  return arr
}

  
ctx=can.getContext('2d',{willReadFrequently:true})


draw=_=>{
  const texts=textarea.value.split('\n')
  
  can.width=8.27*dpi.value
  can.height=11.69*dpi.value

  ctx.font=font.value
  
  
  const charWidth=ctx.measureText(' ').width
  let up=1
  let down=0
  let left=1
  let right=0
  const gridWidth=[]
  
  for(let text of texts){
    const measure=ctx.measureText(text)
    
    up=Math.max(measure.actualBoundingBoxAscent,up)
    down=Math.max(-measure.actualBoundingBoxDescent,down)
    
    left=-measure.actualBoundingBoxLeft
    right=measure.actualBoundingBoxRight
    gridWidth.push(Math.ceil(left+right+charWidth*2))
  }
  const gridHeight=Math.ceil(up+down+charWidth)

  let order=KnuthShuffle(Array.from({length:texts.length},(_,i)=>i))
  let textNum=0

  let startY=gridHeight
  while(startY<can.height){
    
    let x=0
    while(true){
      const textId=order[textNum++%order.length]
  
      let textWidth=gridWidth[textId]
      if(can.width<x+textWidth)break//
  
      const text=texts[textId]
  
      for(let i=0;i<Number(blocksize.value);i++){
        let y=startY+i*gridHeight
        if(can.height<y)break
        ctx.fillText(text,x,y)
      }
      
  
    x+=textWidth}
    
  startY+=Number(blocksize.value)*gridHeight}
  buildinfo.textContent=`${textNum}/${order.length}`
}
await loading('loading')

draw()
dpi.onchange=textarea.onchange=blocksize.onchange=font.onchange=draw


statusCard.remove()
  
})()
  </script>
</body>
</html>